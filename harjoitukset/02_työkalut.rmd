# 2. Työkalujen käyttö: PgAdmin ja psql

Tässä osassa tutustutaan PgAdmin-käyttöliittymään sekä psql:ään.

## 2.1 PgAdmin 4
Käynnistä PgAdmin 4 menemällä osoitteeseen [/pgadmin](/pgadmin). Kirjaudu sisään kouluttajan antamalla tunnuksella ja salasanalla.

![pgAdmin kirjautuminen](img/pgadmin_splash.png)

### 2.1.1 Tietokantayhteyden lisääminen
Luo uusi tietokantayhteys tietokantaklusteriin klikkaamalla hiiren oikealla kohdasta Servers ja valitsemalla Create > Server...

Täytä seuraavat tiedot:

* Välilehdellä General:
  * Name: yhteyden nimi. Vapaavalintainen yhteyden nimi, jolla sen tunnistat myöhemmin. Tyypillinen notaatio on `<käyttäjänimi>@<host>/<tietokanta>`
* Välilehdellä Connection:
  * Host: dbhost (pgadmin ja postgresql ovat dockerin sisällä, joten localhost ei käy tässä)
  * Port: 5432
  * Maintenance database: postgres
  * User: Kysy kouluttajalta
  * Password: Kysy kouluttajalta
  * Valitse Save password, jos et halua kirjoittaa sitä uudestaan avatessasi yhteyden

![Tietokantayhteyden lisääminen](img/pgadmin_create_server.gif)

### 2.1.2 Kyselytyökalun käyttäminen (Query Tool)
Kyselytyökalun avulla voi suorittaa SQL-kyselyitä ja lauseita. Käynnistä se seuraavasti:

* Valitse Servers-osiosta tietokantaklusterisi
* Valitse klusterin sisältä haluamasi tietokanta
* Valitse ylhäältä Tools > Query Tool
* Voit suorittaa lauseita painamalla F5
* Jos haluat suorittaa vain osan lauseista, maalaam hiirellä haluttu osio ja paina F5

![Kyselytyökalun käyttäminen](img/pgadmin_query_tool.gif)

### 2.1.3 Tietokantayhteyden sulkeminen
Klikkaa hiiren oikealla luomastasi yhteydestä ja valitse Disconnect Server. Tämä on erityisen tärkeää, kun kurssilla on monta osallistujaa.

## 2.2 psql

Psql on asennettu valmiiksi koulutusympäristön palvelimelle, jonka komentoriville pääset kirjautumaan osoitteessa [/wetty](/wetty). Kouluttaja antaa linux käyttäjän tunnuksen ja salasanan.

Avaa komentorivi yllämainitussa osoitteessa ja kirjaudu sisään.
Tämän jälkeen yhdistä tietokataklusteriin komennolla:

::: commandline-box
```
psql -h dbhost -d postgres -U postgres
```
:::

* __-h dbhost__ määrittää palvelimen osoitteeseen/nimen, mihin otetaan yhteyttä. (koulutusympäristössä tietokanta on dbhost nimisellä palvelimella)
* __-d postgres__ tietokanta mihin yhdistetään
* __-U postgres__ käyttäjä jolla yhdistetään

### 2.2.1 Käyttäminen
Kun psql on käynnistetty, komentorivillä voit kirjoittaa sekä psql, että SQL-komentoja.
Psql sessiossa käytettäviä erikoiskomentoja kutsutaan interaktiiviseksi psql -komennoiksi.

Alla muutama interaktiivinen psql-komento:

- `\d` = näytä taulut, näkymät ja sekvenssit
- `\dg` = näytä tietokantaklusterin roolit (käyttäjät)
- `\c` tietokannan_nimi = yhdistä tietokannan_nimi -tietokantaan

Komennolla `help` ja erityisesti komennolla `\?` saat tietoa ohjelman eri komennoista. Pääset pois listauksesta painamalla `q`.

SQL-kyselyiden syntaksista saat ohjeita komennolla `\h` esim. `\h ALTER DEFAULT`. Pitkissä dokumenteissa `space`-napilla pääsee seuraavalle sivulle ja `q`-napilla saa "suljettua" ohjeen.

SQL esimerkit:

::: code-box
```sql
select current_database();
```
:::

Komentorivin puolella käytettäviä psql-komentoja kutsutaan ei-interaktiivisiksi. Ei-interaktiivisia psql komentoja käytetään
kun halutaan käyttää psql:a suoraan käyttöjärjestelmän komentoriviltä ja suoritettavat psql-komennot ja SQL-skriptit ovat
tiedostossa. Ei-interaktiivinen psql sopii erityisesti tehtävien automaattisointiin. Esimerkiksi, aiemmin esitetyt
yhteydenottokomennot ovat ei-interaktiivisia psql-komentoja. Kokeile seuraavaa komentoa komentoriviltä:

::: commandline-box
```shell
psql -h dbhost -d postgres -U postgres -c "select current_database();"
``` 
:::
* __-c <SQL>__ SQL lauseke voidaan antaa parametrina psql-ohjelmalle
* __-f <tiedosto.sql>__ tiedostossa oleva sql-skripti voidaan myös antaa parametrina


### 2.2.2 Tietokantayhteyden sulkeminen
Sulkeaksesi tietokantayhteyden anna psql-ohjelmassa komento: 

::: commandline-box

```
\q
```
:::

## 2.3 pg_dump ja pg_restore

Tietokannan tai yksittäisten taulujen varmuuskopioiden luomiseen ja palauttamiseen on omat komentoriviohjelmansa: pg_dump ja pg_restore. Muun muassa pgAdmin käyttää näitä sisäisesti.
