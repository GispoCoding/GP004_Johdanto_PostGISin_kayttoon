# Tietokannan ja taulujen luonti
Tässä osassa luodaan tietokanta, johon lisätään erilaisia tauluja.

## Tietokannan luominen
Tietokannan voi luoda useammalla eri tavalla.

### createdb

createdb on komentorivityökalu helpottamaan tietokannan luomista. Helpoimmillaan uuden tietokannan luominen onnistuukin komennolla:

::: commandline-box
```shell
createdb -h dbhost -U postgres <uuden_tietokannan_nimi>
```
:::

Kuten psql, myös createdb lukee tietokannan yhteysparametrit ympäristömuuttujista.


### PgAdmin

Kuten miltei kaikkeen muuhunkin, PgAdmin tarjoaa myös tietokantojen luomiseen ja poistamiseen graafisen ratkaisun: Klikkaa oikealla tietokantayhteydesta > Create > Database.
![Tietokannan luominen PgAdminilla](img/createdb_pgadmin.gif)


### SQL

Perinteisin tapa tietokantojen luomiseen käy kuitenkin SQL:n kautta. Alla olevan komennon voi suorittaa psql:n tai PgAdminin Query Toolin) avulla:

::: code-box
```sql
CREATE DATABASE <uuden_tietokannan_nimi>;
```
:::

## Tietokannan poistaminen

### dropdb

dropdb samoin kuin createdb on komentorivityökalu. Helpoimmillaan tietokannan voi poistaa komennolla:

::: commandline-box
```shell
dropdb <poistettavan_tietokannan_nimi>
```
:::

### SQL
Samaan tapaan kuin luotaessa

::: code-box
```sql
DROP DATABASE <poistettavan_tietokannan_nimi>;
```
:::

## Harjoitus 3.1: Luo uusi tietokanta
Luo uusi tietokanta "koulutus" createdb:n, pgAdmin:in tai psql:n avulla.

Ota uusi yhteys tähän tietokantaan. PgAdminissa luo uusi tietokantayhteys luvun [Tietokantayhteyden lisääminen] ohjeiden mukaisesti ja anna tietokannaksi postgres.
Tee seuraavat vaiheet tähän tietokantaan.

### Taulujen luominen
PostgreSQL tarjoaa monipuolisen tavan luoda tauluja, näkymiä ja materialisoituja näkymiä.


Luodaan yksinkertainen tietokantataulu kurssi siten, että sillä on kentät koodi, nimi, pvm, tyyli ja kesto.

::: code-box
```sql
CREATE TABLE kurssi (
    koodi    varchar(5) CONSTRAINT firstkey PRIMARY KEY,
    nimi     text NOT NULL,
    pvm      date,
    tyyli    text,
    kesto    integer CHECK (kesto > 0)
);

COMMENT ON COLUMN kurssi.kesto IS 'Kurssin kesto tunteina';
```
:::

Tauluja voi luoda myös SQL-kyselyiden tuloksien perusteella. Luodaan yksinkertainen taulu, johon tulisi kurssi-taulun rivit, joiden kesto on yksi.

::: code-box
```sql
CREATE TABLE kurssi_1 AS (
    SELECT koodi, nimi, pvm, tyyli, 1 kesto FROM kurssi WHERE kesto = 1
);
```
:::


Luonnollisestikin näkymä olisi järkevämpi vaihtoehto äskeiseen:

::: code-box
```sql
CREATE view kurssi_1_view AS (
    SELECT koodi, nimi, pvm, tyyli, kesto FROM kurssi WHERE kesto = 1
);
```
:::

### Rivien lisääminen
Tauluun voidaan lisätä rivejä INSERT-komennoilla, tai esimerkiksi kyselyjen tuloksien avulla

::: code-box
```sql
INSERT INTO kurssi(koodi, nimi, pvm, tyyli, kesto) VALUES
    ('A1111', 'PG-peruskurssi', '2020-10-01', 'Pro', '15');
```
:::


PostgreSQL tukee myös usean rivin lisäämistä yhdellä kertaa ja jos arvot ovat samassa järjestyksessä, kuin kentät, ei kenttien nimiä tarvitse antaa

::: code-box
```sql
INSERT INTO kurssi VALUES
    ('A1112', 'PG-kertaus', '2020-10-03', 'Pro', '1'),
    ('C1111', 'PG-peruskurssi', '2021-10-01', 'Pro', '15'),
    ('C1112', 'PG-seuraavan_vuoden', '2021-10-03', 'Pro', '1');
```
:::

Rivejä voi lisätä myös kyselyjen tuloksena. Tässä hyödynnetään samalla WITH-kyselyitä (CTE, Common Table Expressions).

::: code-box
```sql
WITH alikysely AS (SELECT 1 a, 2 b)
SELECT * FROM alikysely WHERE a = 1;
```
:::

::: code-box
```sql
WITH kertauskurssi AS (SELECT * FROM kurssi WHERE nimi like '%kertaus%')
INSERT INTO kurssi (
    SELECT 'B1111',  nimi, pvm, tyyli 
    FROM kertauskurssi
);
```
:::

### Kyselyjen tekeminen
Tarkistetaan, että rivit ilmeistyivät tauluun. Tyypillisesti ilman hakuehtoa kyselyitä tehdessä kannattaa käyttää LIMIT-ehtoa rajoittaaksesi rivien määrää:

::: code-box
```sql
SELECT * FROM kurssi LIMIT 10;
```
:::

WITH-syntaksin avulla:

::: code-box
```sql
WITH kertauskurssit AS (SELECT * FROM kurssi WHERE nimi LIKE '%kertaus%')
SELECT * FROM kertauskurssit ORDER BY koodi DESC;
```
:::

Tarkistetaan vielä näkymän rivit:

::: code-box
```sql
SELECT * FROM kurssi_1_view LIMIT 10;
```
:::

## Harjoitus 3.2 Taulun luominen
Harjoituksena on luoda uusi tietokantataulu etunimet, joka vastaa tiedoston [etunimet.csv](/data/etunimet.csv) muotoa. Päättele sopivat tietotyypit kentille luentojen sekä edeltävien esimerkkien avulla.
```{r, echo=FALSE, results='hide', message=FALSE}
data <- readr::read_csv("../data/etunimet.csv")
```
```{r, echo=FALSE}
knitr::kable(
  data[1:5, ], 
  caption = "Etunimet.csv tiedoston sisältöä."
)
```

::: code-box
```sql
CREATE TABLE ( ...
```
:::

<button onclick="toggleAnswer(this)" class="btn answer_btn">Näytä ratkaisu</button>

::: hidden-box
::: code-box
```sql
DROP TABLE IF EXISTS etunimet;

CREATE TABLE etunimet (
  nimi text NOT NULL,
  lukumaara integer NOT NULL,
  sukupuoli text NOT NULL
);
```
:::
:::


Nyt lisää tiedoston sisältö tauluun. Tämän voi tehdä SQL:n avulla seuraavasti (superuser-käyttäjällä):

::: code-box
```sql
COPY etunimet(nimi, lukumaara, sukupuoli)
FROM '/home/student/data/<tiedoston-nimi>'
CSV HEADER;
```
:::

tai psql: avulla. Tällöin ei tarvitse olla superuser-käyttäjä (muista kirjautua oikeaan tietokantaan \ckomennolla):

::: commandline-box
```psql
\COPY etunimet FROM '/home/student/data/<tiedoston-nimi>' WITH CSV HEADER
```
:::
HEADER kuvaa sitä, että csv-tiedoston ensimmäinen rivi jätetään huomioimatta, sillä se sisältää sarakkeiden nimet.

Lisää tiedoston sisältö tauluun valitsemallasi tavalla.

<button onclick="toggleAnswer(this)" class="btn answer_btn">Näytä ratkaisu</button>

::: hidden-box
::: code-box
```sql
COPY etunimet(nimi, lukumaara, sukupuoli)
FROM '/home/student/data/etunimet.csv'
CSV HEADER;
```
:::
:::


**Tarkistus:**
Varmistu, että luomassasi taulussa on oikea määrä rivejä ja tutustu halutessasi dataan.

::: code-box
```sql
SELECT count(*) FROM etunimet;
SELECT * FROM etunimet ORDER BY lukumaara DESC LIMIT 100;
```
:::