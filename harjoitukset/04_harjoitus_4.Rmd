# Harjoitus 4: Spatiaaliset SQL-haut

**Harjoituksen sisältö** - Harjoituksessa tutustutaan paikkatietojen tallentamisen perusperiaatteisiin ja suoritetaan muutamia spatiaalisia SQL-hakuja.

**Harjoituksen tavoite** - Harjoituksen jälkeen opiskelijalla on käsitys, kuinka PostGIS-tietokannan spatiaalisia hakuoperaattoreita voidaan käyttää osana paikkatietoanalyysejä.

### Valmistautuminen

:::todo
liekköhän tähän tarvii jottain lisätä
:::

### Paikkatietojen metatiedot

Kaikki PostGIS-tietokannassa olevat paikkatietotaulut on rekisteröity metatieto-tauluihin:

:::todo
pitääkö taulua muokata?

|     |       |
|:--: | :---: |
| <span style="color:purple"> **geography_columns** </span> | Geography-tietotyypin paikkatietotaulut |
| <span style="color:purple"> **geometry_columns** </span> | Geometry-tietotyypin paikkatietotaulut |
| <span style="color:purple"> **raster_columns** </span> | Rasteritietoa sisältävät paikkatietotaulut |
| <span style="color:purple"> **raster_overviews** </span> | Yleistettyjä rasteriaineistoja sisältävät paikkatietotaulut |
:::

## Harjoitus 4.1

Tutki geometry_columns-taulua. Mitä tietoja eri tietokentät sisältävät?

:::code-box
```sql
SELECT *
FROM
geometry_columns;
```
:::

:::hint-box
Onko geometry_columns taulu?
:::   
### Geometrian esittäminen

Tarkastellaan ensin paikkatietojen tallennusmuotoa PostGIS-paikkatietokannassa. Suorita seuraava SQL-lause:

:::code-box
```sql
SELECT
kunta_ni1, maaku_ni1, wkb_geometry
FROM
nlsfi.hallintoalue
WHERE
kunta_ni1 = 'Hanko';
```
:::

Tuloksena näemme geometrian esitystavan, joka ei välttämättä ole tavalliselle paikkatiedon hyödyntäjälle kovin ymmärrettävässä muodossa. Geometriatieto voidaan esittää kuitenkin myös graafisesti ajamalla ao. komennot:

:::code-box
```sql
SELECT
kunta_ni1, maaku_ni1, wkb_geometry
FROM
nlsfi.hallintoalue
WHERE
kunta_ni1 = 'Hanko';
```
:::


pgAdmin:ssa on mahdollista tarkastella geometrioita suoraan graafisessa käyttöliittymässä klikkaamalla pientä silmäikonia ![](img/pgadmin_geom.png) geometriasarakkeen päällä. Mikäli aineistot ovat WGS84-koordinaattijärjestelmässä (EPSG: 4326), pgAdmin myös lisää niihin suoraan taustakartan OpenStreetMapista.

Aineistojen koordinaatistot löytyvät SRID-sarakkeesta. Yhdessä SRID-sarakkeessa voi olla vain yhden koordinaatiston metatiedot. Saat koordinaatit selvempään muotoon seuraavalla hakulausekkeella:

:::code-box
```sql
SELECT
kunta_ni1, maaku_ni1, ST_AsText(wkb_geometry)
FROM
nlsfi.hallintoalue
WHERE
kunta_ni1 = 'Hanko';
```
:::

## Harjoitus 4.2

Kokeile myös seuraavia funktioita Hangon kunnan geometriatietoihin liittyen:

- ST_Boundary

:::code-box
```sql
SELECT ...
```
:::

<button onclick="toggleAnswer(this)" class="btn answer_btn">ratkaisu</button>

:::hidden-box
:::code-box
```sql
SELECT
kunta_ni1, maaku_ni1, ST_AsText(ST_Boundary(wkb_geometry))
FROM
nlsfi.hallintoalue
WHERE
kunta_ni1 = 'Hanko';
```
:::
:::

- ST_Centroid

:::code-box
```sql
SELECT ...
```
:::

<button onclick="toggleAnswer(this)" class="btn answer_btn">ratkaisu</button>

:::hidden-box
:::code-box
```sql
SELECT
kunta_ni1, maaku_ni1, ST_AsText(ST_Centroid(wkb_geometry))
FROM
nlsfi.hallintoalue
WHERE
kunta_ni1 = 'Hanko';
```
:::
:::

- ST_Envelope

:::code-box
```sql
SELECT ...
```
:::

<button onclick="toggleAnswer(this)" class="btn answer_btn">ratkaisu</button>

:::hidden-box
:::code-box
```sql
SELECT
kunta_ni1, maaku_ni1, ST_AsText(ST_Envelope(wkb_geometry))
FROM
nlsfi.hallintoalue
WHERE
kunta_ni1 = 'Hanko';
```
:::
:::

Huomaa, miten vastauksena tuleva geometrian tyyppi vaihtelee eri funktioiden kohdalla.

### Spatiaaliset indeksit

Tarkastele nlsfi.hallintoalue-taulun indeksejä.
- Mitä indeksejä taululle on muodostunut?
- Kuinka taulu eroaa tieviiva-taulun indekseistä? Mistä ero johtuu?


Indeksejä voi tarkastella sekä **pgAdmin**in tai QGIS **DB Manager**in avulla että luomalla tarkoitukseen sopivan SQL-kyselyn.

Luodaan spatiaalinen indeksi taululle tieviiva:

:::code-box
```sql
CREATE INDEX tieviiva_wkb_geometry
ON nlsfi.tieviiva
USING GIST(wkb_geometry);
```
:::

pgAdminissa löydät indeksit valitsemalla Schemas > Tables > Indexes.

Jos käytät psql-komentoriviohjelmaa, voit tarkastella indeksejä seuraavilla psql-komennoilla:

:::commandline-box
```
\dt+ nlsfi.tieviiva
\di+ nlsfi.tieviiva
```
:::

Mikä on tieviivoja sisältävän taulun koko ja miten suuri on siihen tehty indeksi?